name: Termux-Updater CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  issues: write

jobs:
  syntax-check:
    name: Bash Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify Bash script syntax
        id: syntax
        run: |
          set -e
          echo "ðŸ” Checking bash syntax..." > ci_result.log
          find . -type f -name "*.sh" ! -path "./.git/*" -exec bash -n {} \; || {
            echo "âŒ Syntax errors found!" >> ci_result.log
            exit 1
          }
          echo "âœ… Syntax OK" >> ci_result.log

      - name: Upload syntax log artifact
        uses: actions/upload-artifact@v4
        with:
          name: syntax-log
          path: ci_result.log

      - name: Create GitHub Issue on Failure
        if: failure()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Syntax validation failed in CI"
          content-filepath: ci_result.log
          labels: "ci, syntax, automated-report"

      - name: Close Syntax Issue on Success
        if: success()
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ steps.syntax.outputs.issue-number || 0 }}
          comment: "âœ… Syntax validation passed and verified by CI."
          labels: "ci, syntax, resolved-by-ci"
          remove-labels: "automated-report,failed"

  placeholder-tests:
    name: Placeholder Structure Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify required directories
        id: placeholders
        run: |
          echo "ðŸ” Verifying required directories..." > ci_result.log
          REQUIRED=(bin config docs examples modules scripts tests logs tmp)
          for d in "${REQUIRED[@]}"; do
            if [ ! -d "$d" ]; then
              echo "âŒ Missing directory: $d" >> ci_result.log
              exit 1
            fi
          done
          echo "âœ… All required directories exist." >> ci_result.log

      - name: Create GitHub Issue on Failure
        if: failure()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Missing required directories"
          content-filepath: ci_result.log
          labels: "ci, structure, automated-report"

      - name: Close Structure Issue on Success
        if: success()
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ steps.placeholders.outputs.issue-number || 0 }}
          comment: "âœ… All required directories now exist. Auto-closed by CI."
          labels: "ci, structure, resolved-by-ci"
          remove-labels: "automated-report,failed"

  termux-sim:
    name: Termux Simulation Test
    runs-on: ubuntu-latest
    container:
      image: termux/termux-docker:latest
    steps:
      - uses: actions/checkout@v4

      - name: Simulate Termux environment
        id: termux
        run: |
          echo "ðŸ—ï¸ Running Termux simulation..." > ci_result.log
          pkg install -y bash coreutils curl jq git > /dev/null 2>&1 || true
          mkdir -p ~/.update-config/logs ~/.update-config/tmp
          echo "dummy_token" > ~/.update-config/token

          if ! bash bin/update.sh --dry-run 2>>ci_result.log; then
            echo "âŒ Termux simulation failed" >> ci_result.log
            exit 1
          fi
          echo "âœ… Termux simulation passed." >> ci_result.log

      - name: Create GitHub Issue on Failure
        if: failure()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Termux simulation failed"
          content-filepath: ci_result.log
          labels: "ci, termux, automated-report"

      - name: Close Termux Issue on Success
        if: success()
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ steps.termux.outputs.issue-number || 0 }}
          comment: "âœ… Termux simulation now passes. Issue resolved automatically."
          labels: "ci, termux, resolved-by-ci"
          remove-labels: "automated-report,failed"

  version-sync:
    name: Cross-Platform Sync Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify structure parity
        id: sync
        run: |
          echo "ðŸ” Checking parity between local and remote branches..." > ci_result.log
          git fetch origin main
          LOCAL_COUNT=$(find . -type f | wc -l)
          REMOTE_COUNT=$(git ls-tree -r origin/main --name-only | wc -l)
          echo "Local: $LOCAL_COUNT" >> ci_result.log
          echo "Remote: $REMOTE_COUNT" >> ci_result.log
          if [ "$LOCAL_COUNT" -lt "$REMOTE_COUNT" ]; then
            echo "âŒ Local missing files. Sync needed." >> ci_result.log
            exit 1
          else
            echo "âœ… Structures match." >> ci_result.log
          fi

      - name: Create GitHub Issue on Failure
        if: failure()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Version synchronization mismatch"
          content-filepath: ci_result.log
          labels: "ci, sync, automated-report"

      - name: Close Sync Issue on Success
        if: success()
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ steps.sync.outputs.issue-number || 0 }}
          comment: "âœ… Version synchronization resolved and validated by CI."
          labels: "ci, sync, resolved-by-ci"
          remove-labels: "automated-report,failed"

